<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f1f1f1;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            position: relative;
        }

        .chart-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin: 50px;
        }

        .chart-item {
            width: 450px;
            height: 600px; /* Further increased height */
            border-radius: 5px;
            text-align: center;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin: 20px;
            background-color: #fff;
        }

        .chart-item:hover {
            transform: translateY(-5px);
        }

        .chart-buttons {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .chart-buttons button {
            padding: 5px 8px;
            border: none;
            background-color: #007bff;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .chart-buttons button:hover {
            background-color: #0056b3;
        }

        .action-buttons {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .action-buttons button {
            padding: 8px 12px;
            border: none;
            background-color: #007bff;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .top-buttons {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-buttons">
            <button class="btn btn-outline-secondary" onclick="window.location.href='/'">Back</button>
            <button class="btn btn-outline-danger" onclick="logout()">Logout</button>
        </div>
        <h2 class="text-center">Dashboard</h2>
        <div class="chart-grid" id="charts-container">
            <!-- Charts will be dynamically inserted here -->
        </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Custom JS -->
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const chartsContainer = document.getElementById('charts-container');
            const backButton = document.getElementById('backButton');
            
            // Function to get query parameters from URL
            function getQueryParams() {
                const params = {};
                window.location.search.substring(1).split('&').forEach(param => {
                    const [key, value] = param.split('=');
                    params[key] = decodeURIComponent(value);
                });
                return params;
            }
            
            const urlParams = getQueryParams();
            const formId = urlParams.id; // Get the form ID from query parameters

            console.log(formId); // Log the formId to console for debugging

            try {
                const response = await fetch(`http://127.0.0.1:3000/forms/fetch/${formId}/`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                if (!response.ok) {
                    const errorMessage = await response.text();  // Get error response text
                    throw new Error(`Network response was not ok: ${errorMessage}`);
                }

                const formData = await response.json();
                console.log(formData); // Log the fetched details to the console

                if (formData.metadata && Array.isArray(formData.metadata.questions)) {
                    formData.metadata.questions.forEach((question, index) => {
                        if (question.type === 'choice' || question.type === 'checkbox') {
                            createChart(question, formData.responses, index);
                        }
                    });
                } else {
                    console.error('Invalid questions data:', formData.metadata?.questions);
                    chartsContainer.innerHTML = `<div class="alert alert-danger">Invalid questions data</div>`;
                }
            } catch (error) {
                console.error('Error fetching form details:', error);
                chartsContainer.innerHTML = `<div class="alert alert-danger">Error fetching form details: ${error.message}</div>`;
            }

            // Back button event listener
            backButton.addEventListener('click', function() {
                window.location.href = '/';
            });

        });

        function createChart(question, responses, index) {
            const chartsContainer = document.getElementById('charts-container');

            // Initialize choice counts
            const choiceCounts = question.choices.reduce((acc, choice) => {
                acc[choice] = 0;
                return acc;
            }, {});

            // Count the occurrences of each choice
            responses.forEach(response => {
                const responseData = response.response_data[`q${index + 1}`];
                console.log(`Response data for question ${question.text}:`, responseData); // Log the response data

                if (Array.isArray(responseData)) {
                    responseData.forEach(choice => {
                        if (choice in choiceCounts) {
                            choiceCounts[choice]++;
                        }
                    });
                } else if (typeof responseData === 'string') {
                    const choices = responseData.split(',').map(choice => choice.trim());
                    choices.forEach(choice => {
                        if (choice in choiceCounts) {
                            choiceCounts[choice]++;
                        }
                    });
                }
            });

            // Log the counts for each choice
            console.log(`Counts for question: ${question.text}`);
            for (const [choice, count] of Object.entries(choiceCounts)) {
                console.log(`${choice}: ${count}`);
            }

            // Prepare data for the chart
            const labels = Object.keys(choiceCounts);
            const data = Object.values(choiceCounts);

            const chartElement = document.createElement('div');
            chartElement.classList.add('chart-item');
            chartElement.innerHTML = `
                <h5>${question.text}</h5>
                <canvas id="chart${index}Canvas"></canvas>
                <div class="chart-buttons">
                    <button onclick="changeChartType('pie', ${index})">Pie</button>
                    <button onclick="changeChartType('bar', ${index})">Bar</button>
                    <button onclick="changeChartType('line', ${index})">Line</button>
                </div>
            `;
            chartsContainer.appendChild(chartElement);

            const ctx = document.getElementById(`chart${index}Canvas`).getContext('2d');

            const chartData = {
                labels: labels,
                datasets: [{
                    label: question.text,
                    data: data,
                    backgroundColor: labels.map((_, i) => `hsl(${i * 60}, 70%, 50%)`)
                }]
            };

            window[`chart${index}`] = new Chart(ctx, {
                type: 'pie',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: question.text
                        }
                    }
                }
            });
        }

        function changeChartType(type, index) {
            const chart = window[`chart${index}`];
            chart.config.type = type;
            chart.update();
        }
        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            window.location.href = '/accounts/login/';
        }

    </script>
</body>
</html>
